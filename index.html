<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>O JOGO DA MEMÃ“RIA MAIS COMPETITIVO DO MUNDO</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
Â  --bg:#071017; --panel:#0e1622; --accent:#ffd166; --accent2:#7ce7c7; --muted:#9aa7bf;
Â  --gap:10px; --cols:4; --card-max:96px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#04101a,#071018);font-family:'Press Start 2P', monospace;color:#eaf2ff;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}

/* CORREÃ‡ÃƒO: Container principal com apenas uma coluna para as abas */
.container{max-width:760px;margin:14px auto;padding:12px;display:grid;grid-template-columns:1fr;gap:16px}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.title{color:var(--accent);font-size:12px}
.sub{color:var(--muted);font-size:10px}

/* HUD */
.hud{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.chip{background:#07131a;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-size:11px;color:var(--muted)}

/* Grid responsive: use CSS variable --card-size set by JS */
.grid{display:grid;grid-template-columns:repeat(var(--cols), var(--card-size));gap:var(--gap);justify-content:center;padding:8px;background:linear-gradient(180deg,#04121a,#071426);border-radius:8px}

/* NOVO: Estilos para 5 e 6 colunas (Desktop) */
@media (min-width: 521px) {
    .grid[data-cols="5"] { grid-template-columns: repeat(5, var(--card-size)); }
    .grid[data-cols="6"] { grid-template-columns: repeat(6, var(--card-size)); }
}

.card{width:var(--card-size);height:var(--card-size);perspective:700px;border-radius:6px;cursor:pointer;position:relative}
.card-inner{width:100%;height:100%;position:relative;transition:transform .5s;transform-style:preserve-3d;border-radius:6px;box-shadow:0 6px 12px rgba(0,0,0,0.5)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:calc(var(--card-size) * 0.42);backface-visibility:hidden;user-select:none}
.face.front{background:repeating-linear-gradient(45deg,#08131a,#08131a 6px,#0b1a24 6px);color:#bcd7ff}
.face.back{background:linear-gradient(180deg,#2b163a,#151028);color:var(--accent2);transform:rotateY(180deg)}

/* NOVO: Estilo para cartas que devem sumir apÃ³s o match */
.card.matched-out {
    opacity: 0;
    transform: scale(0.8); /* Efeito de encolher */
    transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* TransiÃ§Ã£o mais suave */
    pointer-events: none; /* Impede cliques em cartas que estÃ£o sumindo */
}


/* controls (mobile friendly) */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
.input, select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:12px}
.btn{background:var(--accent);color:#071018;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}

/* Estilo do Chat e Ranking (Caixas) */
.box{background:linear-gradient(180deg,#061018,#07101a);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-size:12px}
.chat-window{height:300px;overflow:auto;padding:6px;border-radius:6px;background:linear-gradient(180deg,#041016,#051018)}
.chat-row{margin-bottom:8px}
.chat-name{color:var(--accent2);font-weight:700;margin-right:6px}
.chat-time{color:var(--muted);font-size:10px;margin-left:8px}

.leader-row{display:flex;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}

/* small */
.footer{font-size:11px;color:var(--muted);text-align:center;margin-top:8px}
@media (max-width:520px){
Â  :root{--cols:3}
  /* NOVO: Ajusta o seletor de dificuldade no mobile */
  .controls select {
    flex: 1 1 auto;
    min-width: unset;
  }
}
/* Novo CSS para abas */
.tab-header {
Â  Â  display: flex;
Â  Â  gap: 8px;
Â  Â  margin-bottom: 12px;
Â  Â  /* Faz o header da aba ocupar a largura total do panel */
Â  Â  margin: -14px -14px 12px -14px;Â 
Â  Â  padding: 14px 14px 0 14px;
Â  Â  background: var(--panel);
Â  Â  border-radius: 10px 10px 0 0;
}
.tab-btn {
Â  Â  background: transparent;
Â  Â  color: var(--muted);
Â  Â  border: none;
Â  Â  padding: 8px 12px;
Â  Â  border-radius: 8px 8px 0 0;
Â  Â  font-size: 11px;
Â  Â  font-weight: 700;
Â  Â  cursor: pointer;
Â  Â  transition: color 0.2s;
}
.tab-btn.active {
Â  Â  color: var(--accent);
Â  Â  background: var(--bg);
}
.tab-panel:not(.active) {
Â  Â  display: none;
}
.auth-controls {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 10px;
}
</style>
</head>
<body>
<div class="container">
Â  <div class="panel">

Â  Â  <div class="tab-header">
Â  Â  Â  Â  <button id="tabAppBtn" class="tab-btn">ğŸ•¹ï¸ InÃ­cio</button>
Â  Â  Â  Â  <button id="tabChatBtn" class="tab-btn">ğŸ’¬ Chat</button>
Â  Â  Â  Â  <button id="tabRankBtn" class="tab-btn">ğŸ† Ranking</button>
Â  Â  Â  Â  <button id="tabAuthBtn" class="tab-btn">ğŸ”’ Cadastro/Login</button>
Â  Â  </div>

Â  Â  <div id="mainApp" class="tab-panel">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="title">PIXEL RPG MEMORY</div>
Â  Â  Â  Â  Â  Â  <div class="sub">Pixel-art moderno â€¢ Mobile-first</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align:right">
Â  Â  Â  Â  Â  Â  <div style="font-size:10px;color:var(--muted)">API: <span id="apiStatus">verificandoâ€¦</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="hud">
Â  Â  Â  Â  Â  <div class="chip">Jogador: <span id="playerHUD">Anon</span></div>
Â  Â  Â  Â  Â  <div class="chip">Tempo: <span id="timeHUD">00:00</span></div>
Â  Â  Â  Â  Â  <div class="chip">Tentativas: <span id="triesHUD">0</span></div>
Â  Â  Â  Â  Â  <div class="chip">Melhor: <span id="bestHUD">--:--</span></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="grid" class="grid"></div>

Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chip" style="background: transparent; border: none; font-size: 12px; color: var(--accent2);">
Â  Â  Â  Â  Â  Â  Â  Jogador: <span id="playerNameDisplay">Anon</span>
Â  Â  Â  Â  Â  </div>
          <select id="difficultySelect" class="input">
              <option value="4x4">FÃ¡cil (4x4)</option>
              <option value="5x4">MÃ©dio (5x4)</option>
              <option value="6x4">DifÃ­cil (6x4)</option>
          </select>
Â  Â  Â  Â  Â  <select id="skinSelect" class="input">
Â  Â  Â  Â  Â  Â  <option value="plain">Classic</option>
Â  Â  Â  Â  Â  Â  <option value="darker">Darker</option>
Â  Â  Â  Â  Â  Â  <option value="neon">Neon</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <button id="startBtn" class="btn">Start</button>
Â  Â  Â  Â  Â  <button id="resetBtn" class="btn ghost">Reset</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="footer">Toque nas cartas para virar â€” objetivo: terminar no menor tempo</div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="chatPanel" class="tab-panel">
Â  Â  Â  Â  <div class="box" style="margin-top: 0;">
Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color:var(--accent)">ğŸ’¬ Chat Global</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="clearChat" class="btn ghost" style="padding:6px">Limpar Local</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="chatWindow" class="chat-window"></div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="chip" id="chatNameDisplay" style="flex-shrink: 0; padding: 10px;">@Anon</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="chatMsg" class="input" placeholder="Mensagem..." />
Â  Â  Â  Â  Â  Â  Â  Â  <button id="chatSend" class="btn">Enviar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="chatNotice" style="margin-top:8px;color:var(--muted);font-size:11px"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="rankPanel" class="tab-panel">
Â  Â  Â  Â  <div class="box" style="margin-top: 0;">
Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color:var(--accent)">ğŸ† Ranking Global</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <div><button id="refreshRank" class="btn ghost">Atualizar</button></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="leaderboard"></div>
Â  Â  Â  Â  Â  Â  <div id="rankNotice" style="margin-top:8px;color:var(--muted);font-size:11px"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="authPanel" class="tab-panel">
Â  Â  Â  Â  <div class="auth-controls">
Â  Â  Â  Â  Â  Â  <h3 class="title" style="margin-top: 0; margin-bottom: 0">Acessar Conta</h3>
Â  Â  Â  Â  Â  Â  <div id="authState" class="chip" style="color: var(--accent2);">Status: Desconectado</div>
Â  Â  Â  Â  Â  Â  <p style="font-size: 11px; color: var(--muted); margin: 0;">*O nome de usuÃ¡rio Ã© o nome que vocÃª salvarÃ¡ no Supabase.</p>
Â  Â  Â  Â  Â  Â  <input id="userEmail" class="input" placeholder="E-mail" />
Â  Â  Â  Â  Â  Â  <input id="userPassword" class="input" type="password" placeholder="Senha" />
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <input id="authPlayerName" class="input" placeholder="@seunome (ObrigatÃ³rio para cadastro)" />

Â  Â  Â  Â  Â  Â  <div style="display:flex; gap: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="signInBtn" class="btn" style="flex:1">Login</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="signUpBtn" class="btn ghost" style="flex:1">Cadastrar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="signOutBtn" class="btn ghost" style="background: #a82e2e; color: white; display: none;">Sair (Logout)</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>
<script type="module">
Â  // 1. Importa a biblioteca do Supabase
Â  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

Â  // 2. VariÃ¡veis de conexÃ£o - SUBSTITUÃDAS COM SEUS VALORES
Â  const SUPABASE_URL = 'https://qkezkaiormdbmknisqdp.supabase.co';Â 
Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXprYWlvcm1kYm1rbmlzcWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjc0NDgsImV4cCI6MjA3ODc0MzQ0OH0.6kDMREZKD6z-ryyxP58ezqINhcZXZaR41cgPsdzRswo';Â 

Â  // 3. Inicializa a conexÃ£o (Web Client)
Â  const supabaseWeb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â Â 
Â  // ----------------------------------------------------
Â  // CONFIGURAÃ‡Ã•ES E VARIÃVEIS
Â  // ----------------------------------------------------
Â Â 
const API_CHAT = '/api/chat';
const API_RANKING = '/api/ranking';
const POLL_CHAT_MS = 2000;
const POLL_RANK_MS = 4000;
// AUMENTADO O NÃšMERO DE EMOJIS PARA SUPORTAR DIFICULDADES MAIORES
const ALL_EMOJIS = ['ğŸ“','ğŸ','ğŸ‰','ğŸ‡','ğŸ¥','ğŸ‹','ğŸ¥­','ğŸ’', 'ğŸ‘', 'ğŸ¥¥', 'ğŸŒ', 'ğŸ'];
const STORAGE_CHAT = 'prm_chat_v1';
const STORAGE_RANK = 'prm_rank_v1';
const STORAGE_BEST = 'prm_best_v1';
const STORAGE_DIFF = 'prm_diff_v1'; // Armazenar a dificuldade

/* ---------- DOM ---------- */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');

const playerNameDisplay = document.getElementById('playerNameDisplay');
const chatNameDisplay = document.getElementById('chatNameDisplay');Â 

const playerHUD = document.getElementById('playerHUD');
const timeHUD = document.getElementById('timeHUD');
const triesHUD = document.getElementById('triesHUD');
const bestHUD = document.getElementById('bestHUD');
const apiStatus = document.getElementById('apiStatus');

const chatWindow = document.getElementById('chatWindow');
const chatMsg = document.getElementById('chatMsg');
const chatSend = document.getElementById('chatSend');
const chatNotice = document.getElementById('chatNotice');

const leaderboardEl = document.getElementById('leaderboard');
const refreshRank = document.getElementById('refreshRank');
const clearChatBtn = document.getElementById('clearChat');
const rankNotice = document.getElementById('rankNotice');

// Elementos de Auth e Abas
const authStateEl = document.getElementById('authState');
const tabAppBtn = document.getElementById('tabAppBtn');
const tabChatBtn = document.getElementById('tabChatBtn');Â 
const tabRankBtn = document.getElementById('tabRankBtn');Â 
const tabAuthBtn = document.getElementById('tabAuthBtn');

const signOutBtn = document.getElementById('signOutBtn');Â 
const signUpBtn = document.getElementById('signUpBtn');
const signInBtn = document.getElementById('signInBtn');
const authPlayerNameInput = document.getElementById('authPlayerName');Â 
const difficultySelect = document.getElementById('difficultySelect'); // Seletor de dificuldade

/* ---------- STATE ---------- */
let currentUserName = localStorage.getItem('currentUserName') || 'Anon';Â 
let cards = [], first=null, second=null, lock=false, matches=0, attempts=0;
let timer=0, timerId=null, started=false;
let currentDifficulty = localStorage.getItem(STORAGE_DIFF) || '4x4'; // Pega a dificuldade salva
let bestLocal = localStorage.getItem(STORAGE_BEST) ? parseInt(localStorage.getItem(STORAGE_BEST)) : null;
if(bestLocal) bestHUD.textContent = formatTime(bestLocal);

/* ---------- RESPONSIVE CARD SIZE (AJUSTADO PARA DIFICULDADE) ---------- */
function computeCardSize(){
Â  // Pega a dificuldade atual
Â  const [colsStr, rowsStr] = currentDifficulty.split('x');
  // Se a dificuldade for invÃ¡lida ou nÃ£o suportada, volta para 4
  const cols = parseInt(colsStr) || 4; 
  
Â  // NOVO: Atualiza a variÃ¡vel CSS e o atributo data-cols na grid
  document.documentElement.style.setProperty('--cols', cols);
  grid.setAttribute('data-cols', cols);

Â  // Usa a largura do container/viewport
Â  const containerWidth = Math.min(window.innerWidth - (window.innerWidth <= 520 ? 12 : 40), 720);
Â  // Ajusta espaÃ§amento
Â  const gap = window.innerWidth <= 520 ? 6 : 10;
Â  document.documentElement.style.setProperty('--gap', gap + 'px');
Â  // Calcula o tamanho da carta
Â  const w = Math.floor((containerWidth - (cols-1)*gap - (window.innerWidth <= 520 ? 20 : 16)) / cols);
Â  const size = Math.max(56, Math.min(w, 110));
Â  document.documentElement.style.setProperty('--card-size', size + 'px');
}
window.addEventListener('resize', computeCardSize);


/* ---------- UTIL (MANTIDO) ---------- */
function formatTime(s){const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ---------- ABAS (MANTIDO) ---------- */
function showTab(tabId) {
Â  Â  // Limpa a classe 'active' de todos os painÃ©is e botÃµes
Â  Â  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
Â  Â  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    // Adiciona 'active' ao painel correspondente
Â  Â  const panel = document.getElementById(tabId);
    if(panel) panel.classList.add('active');
Â  Â Â 
Â  Â  // Adiciona 'active' ao botÃ£o correspondente
Â  Â  const btnMap = {
Â  Â  Â  Â  'mainApp': 'tabAppBtn',
Â  Â  Â  Â  'chatPanel': 'tabChatBtn',
Â  Â  Â  Â  'rankPanel': 'tabRankBtn',
Â  Â  Â  Â  'authPanel': 'tabAuthBtn'
Â  Â  };
Â  Â  const btn = document.getElementById(btnMap[tabId]);
    if (btn) btn.classList.add('active');
}

/* ---------- GRID, GAME LOGIC (AJUSTADO) ---------- */
function createGrid(){
Â  grid.innerHTML='';
Â  
Â  // Determina quantos pares de cartas sÃ£o necessÃ¡rios
Â  const [colsStr, rowsStr] = currentDifficulty.split('x');
  const totalCards = (parseInt(colsStr) || 4) * (parseInt(rowsStr) || 4);
  const totalPairs = totalCards / 2;
  
  // Seleciona o nÃºmero necessÃ¡rio de emojis
  const selectedEmojis = ALL_EMOJIS.slice(0, totalPairs);
  
  // Se nÃ£o houver emojis suficientes, alerta
  if (selectedEmojis.length < totalPairs) {
      alert(`Erro: A dificuldade ${currentDifficulty} requer ${totalPairs} pares, mas sÃ³ hÃ¡ ${ALL_EMOJIS.length} disponÃ­veis.`);
      return;
  }
  
  // Cria o array de cartas e embaralha
Â  const arr = shuffle([...selectedEmojis, ...selectedEmojis]);
Â  cards = [];

Â  arr.forEach((emoji,idx)=>{
Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'card';
Â  Â  card.dataset.emoji = emoji;
Â  Â  card.innerHTML = `<div class="card-inner"><div class="face front">?</div><div class="face back">${emoji}</div></div>`;
Â  Â  card.addEventListener('click', onCardClick);
Â  Â  grid.appendChild(card);
Â  Â  cards.push(card);
Â  });
Â  
Â  matches = 0; // Zera o contador de matches global
Â  resetHUD();
}
function resetHUD(){Â 
Â  Â  attempts=0;Â 
Â  Â  triesHUD.textContent='0';Â 
Â  Â  stopTimer();Â 
Â  Â  timer=0;Â 
Â  Â  timeHUD.textContent='00:00';Â 
Â  Â  started=false;Â 
Â  Â  playerHUD.textContent = currentUserName || 'Anon';Â 
Â  Â  playerNameDisplay.textContent = currentUserName || 'Anon';
}

function startTimer(){ if(timerId) return; timerId = setInterval(()=>{ timer++; timeHUD.textContent = formatTime(timer); }, 1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

function onCardClick(e){
Â  if(lock) return;
Â  const c = e.currentTarget;
Â  if(c.classList.contains('flipped')) return;
Â  if(!started){ started=true; startTimer(); }
Â  c.classList.add('flipped');
Â  if(!first) first=c;
Â  else { second=c; lock=true; attempts++; triesHUD.textContent=attempts; setTimeout(checkMatch, 500); }
}

// NOVO: FunÃ§Ã£o checkMatch com AnimaÃ§Ã£o de Desaparecimento
function checkMatch(){
Â  if(first.dataset.emoji === second.dataset.emoji){
Â  Â  matches++; 
Â  Â  
Â  Â  // 1. Aplica a classe para iniciar o efeito visual
Â  Â  first.classList.add('matched-out'); 
Â  Â  second.classList.add('matched-out');
Â  Â  
Â  Â  // 2. Adiciona um efeito sonoro ou vibraÃ§Ã£o aqui (opcional)

Â  Â  // 3. Remove as cartas do DOM e continua a lÃ³gica
Â  Â  setTimeout(() => {
        // Verifica se as cartas ainda existem antes de tentar remover
        if (first && first.parentNode) first.remove();
        if (second && second.parentNode) second.remove();
        
        // Zera as variÃ¡veis de controle do clique
Â  Â  Â  Â  [first,second]=[null,null]; 
Â  Â  Â  Â  lock=false;
Â  Â  Â  Â  
Â  Â  Â  Â  // Pega o nÃºmero total de pares da dificuldade atual
Â  Â  Â  Â  const [colsStr, rowsStr] = currentDifficulty.split('x');
        const totalPairs = ((parseInt(colsStr) || 4) * (parseInt(rowsStr) || 4)) / 2;
        
        // Verifica a vitÃ³ria
Â  Â  Â  Â  if(matches === totalPairs){ 
Â  Â  Â  Â  Â  Â  stopTimer(); 
Â  Â  Â  Â  Â  Â  handleWin(); 
Â  Â  Â  Â  }
Â  Â  }, 350); // Tempo da animaÃ§Ã£o no CSS

Â  } else {
Â  Â  first.classList.remove('flipped'); 
Â  Â  second.classList.remove('flipped');
Â  Â  [first,second]=[null,null]; 
Â  Â  lock=false;
Â  }
}


async function handleWin(){
Â  const name = (currentUserName || 'Anon').slice(0,30);
Â  // save local best
Â  if(!bestLocal || timer < bestLocal){ bestLocal = timer; localStorage.setItem(STORAGE_BEST, String(bestLocal)); bestHUD.textContent = formatTime(bestLocal); }
Â  // attempt to send ranking
Â  // Adicionar a dificuldade ao payload aqui Ã© crucial para rankings segmentados
Â  const payload = { name, time: timer, difficulty: currentDifficulty }; 
Â  let sent = false;
Â  try{
Â  Â  // OBS: A sua API /api/ranking precisa ser atualizada para receber 'difficulty'
Â  Â  const res = await fetch(API_RANKING, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
Â  Â  if(res.ok){ sent = true; rankNotice.textContent = 'Tempo enviado ao ranking global!'; }
Â  }catch(e){ rankNotice.textContent = 'Ranking offline â€” salvo localmente'; }
Â  if(!sent){
Â  Â  // fallback local store
Â  Â  const L = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
Â  Â  // Adiciona o campo de dificuldade ao salvar localmente
Â  Â  L.push({ name, time: timer, at: Date.now(), difficulty: currentDifficulty }); 
Â  Â  L.sort((a,b)=>a.time - b.time);
Â  Â  localStorage.setItem(STORAGE_RANK, JSON.stringify(L.slice(0,100)));
Â  } else {
Â  Â  await loadRanking();
Â  }
Â  alert(`ParabÃ©ns ${name}! Dificuldade: ${currentDifficulty}. Tempo: ${formatTime(timer)}.`);
}

/* ---------- AUTENTICAÃ‡ÃƒO (MANTIDO) ---------- */
async function fetchUserName(userId) {
Â  Â  const { data, error } = await supabaseWeb
Â  Â  Â  Â  .from('users')
Â  Â  Â  Â  .select('name')
Â  Â  Â  Â  .eq('id', userId)
Â  Â  Â  Â  .single();
Â  Â Â 
Â  Â  let userName = 'Anon';
Â  Â  if (error && error.code !== 'PGRST116') {Â 
Â  Â  Â  Â  console.error('Erro ao buscar nome do usuÃ¡rio:', error.message);
Â  Â  }
Â  Â Â 
Â  Â  if (data && data.name) {Â 
Â  Â  Â  Â  userName = data.name;
Â  Â  }Â 
Â  Â Â 
Â  Â  currentUserName = userName; // ATUALIZA VARIÃVEL GLOBAL
Â  Â  playerHUD.textContent = userName;
Â  Â  playerNameDisplay.textContent = userName; // Atualiza o display na aba InÃ­cio
Â  Â  chatNameDisplay.textContent = `@${userName}`; // Atualiza o display na aba Chat
Â  Â  authPlayerNameInput.value = userName; // Preenche o campo na aba de Auth
}

function updateAuthUI(user) {
Â  Â  if (user) {
Â  Â  Â  Â  authStateEl.innerHTML = `Logado como: ${user.email.split('@')[0]}`;
Â  Â  Â  Â  signOutBtn.style.display = 'block';
Â  Â  Â  Â  signUpBtn.style.display = 'none';
Â  Â  Â  Â  signInBtn.style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  fetchUserName(user.id);Â 

Â  Â  } else {
Â  Â  Â  Â  authStateEl.textContent = 'Status: Desconectado';
Â  Â  Â  Â  signOutBtn.style.display = 'none';
Â  Â  Â  Â  signUpBtn.style.display = 'inline-block';
Â  Â  Â  Â  signInBtn.style.display = 'inline-block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentUserName = 'Anon'; // ATUALIZA VARIÃVEL GLOBAL
Â  Â  Â  Â  playerHUD.textContent = 'Anon';
Â  Â  Â  Â  playerNameDisplay.textContent = 'Anon'; // Atualiza o display na aba InÃ­cio
Â  Â  Â  Â  chatNameDisplay.textContent = `@Anon`; // Atualiza o display na aba Chat
Â  Â  Â  Â  authPlayerNameInput.value = ''; // Limpa o campo de input na aba de Auth
Â  Â  }
}

async function handleAuth(isSignUp) {
Â  Â  const emailEl = document.getElementById('userEmail');
Â  Â  const passwordEl = document.getElementById('userPassword');
Â  Â  const playerName = authPlayerNameInput.value.trim(); // PEGA O NOME DA ABA DE AUTH
Â  Â Â 
Â  Â  const email = emailEl.value.trim();
Â  Â  const password = passwordEl.value.trim();

Â  Â  if (!email || !password) {
Â  Â  Â  Â  alert('Por favor, preencha E-mail e Senha.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  // Para cadastro, o nome nÃ£o pode ser vazio
Â  Â  if (isSignUp && !playerName) {
Â  Â  Â  Â  alert('Por favor, defina um nome de usuÃ¡rio.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  let authResult;

Â  Â  if (isSignUp) {
Â  Â  Â  Â  authResult = await supabaseWeb.auth.signUp({ email, password });
Â  Â  } else {
Â  Â  Â  Â  authResult = await supabaseWeb.auth.signInWithPassword({ email, password });
Â  Â  }

Â  Â  if (authResult.error) {
Â  Â  Â  Â  alert(`Erro de autenticaÃ§Ã£o: ${authResult.error.message}`);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (authResult.data.user) {
Â  Â  Â  Â  const userId = authResult.data.user.id;
Â  Â  Â  Â  const { error: insertError } = await supabaseWeb
Â  Â  Â  Â  Â  Â  .from('users')
Â  Â  Â  Â  Â  Â  .upsert([{ id: userId, name: playerName || currentUserName }], { onConflict: 'id' });Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (insertError) {
Â  Â  Â  Â  Â  Â  Â console.error('Erro ao salvar nome na tabela users:', insertError.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (isSignUp) {
Â  Â  Â  Â  alert(`Sucesso! Verifique seu e-mail para confirmar o cadastro.`);
Â  Â  }

Â  Â  supabaseWeb.auth.getSession().then(({ data: { session } }) => updateAuthUI(session?.user));
Â  Â  loadChat();Â 
Â  Â  showTab('mainApp');Â 
}

async function handleSignOut() {
Â  Â  const { error } = await supabaseWeb.auth.signOut();
Â  Â  if (error) {
Â  Â  Â  Â  alert(`Erro ao sair: ${error.message}`);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  alert('Desconectado com sucesso!');
Â  Â  updateAuthUI(null);
Â  Â  loadChat();Â 
}

/* ---------- CHAT e RANKING (MANTIDO) ---------- */
async function loadChat(){
Â  // try API
Â  try{
Â  Â  const res = await fetch(API_CHAT);
Â  Â  if(res.ok){
Â  Â  Â  const data = await res.json();
Â  Â  Â  renderChat(data);
Â  Â  Â  apiStatus.textContent = 'online';
Â  Â  Â  return;
Â  Â  }
Â  }catch(e){}
Â  apiStatus.textContent = 'offline (local)';
Â  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
Â  renderChat(local);
}
function renderChat(list){
Â  chatWindow.innerHTML = '';
Â  list.slice(-200).forEach(it=>{
Â  Â  const row = document.createElement('div'); row.className='chat-row';
Â  Â  const msgText = it.message || it.msg || '';Â 
Â  Â  row.innerHTML = `<span class="chat-name">${escapeHtml(it.name)}</span>: ${escapeHtml(msgText)} <span class="chat-time">${new Date(it.at||Date.now()).toLocaleTimeString()}</span>`;
Â  Â  chatWindow.appendChild(row);
Â  });
Â  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendChat() {Â 
Â  // Pega o nome da variÃ¡vel global (nÃ£o de um input)
Â  const name = (currentUserName || 'Anon').slice(0, 30);
Â  const msg = (chatMsg.value || '').trim();

Â  if (!msg) return;

Â  const { data: { session }, error: sessionError } = await supabaseWeb.auth.getSession();

Â  if (sessionError || !session || !session.user) {
Â  Â  chatNotice.textContent = 'ERRO: VocÃª deve estar logado para enviar mensagens!';
Â  Â  return;
Â  }
Â  const currentUserId = session.user.id;
Â  const accessToken = session.access_token;Â 

Â  const payload = {Â 
Â  Â  name,Â 
Â  Â  message: msg,Â 
Â  Â  user_id: currentUserIdÂ 
Â  };
Â Â 
Â  try {
Â  Â  const res = await fetch(API_CHAT, {Â 
Â  Â  Â  method: 'POST',Â 
Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${accessToken}`Â 
Â  Â  Â  Â  },Â 
Â  Â  Â  body: JSON.stringify(payload)Â 
Â  Â  });

Â  Â  if (res.ok) {
Â  Â  Â  chatMsg.value = '';
Â  Â  Â  chatNotice.textContent = 'Mensagem enviada';
Â  Â  Â  loadChat();Â 
Â  Â  Â  return;Â 
Â  Â  }
Â  Â  chatNotice.textContent = `Erro ao enviar chat: ${res.statusText}`;

Â  } catch(e) {
Â  Â  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
Â  Â  local.push({ name, msg, at: Date.now() });
Â  Â  localStorage.setItem(STORAGE_CHAT, JSON.stringify(local.slice(-500)));
Â  Â  chatMsg.value = '';
Â  Â  chatNotice.textContent = 'Chat offline - mensagem salva localmente';
Â  Â  loadChat();
Â  }
}


async function loadRanking(){
Â  try{
Â  Â  const res = await fetch(API_RANKING);
Â  Â  if(res.ok){
Â  Â  Â  const data = await res.json();
Â  Â  Â  renderRanking(data);
Â  Â  Â  apiStatus.textContent = 'online';
Â  Â  Â  return;
Â  Â  }
Â  }catch(e){}
Â  apiStatus.textContent = 'offline (local)';
Â  // Filtra o ranking local pela dificuldade atual para exibir apenas resultados relevantes
Â  const allLocal = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
  const localFiltered = allLocal.filter(r => r.difficulty === currentDifficulty);
Â  renderRanking(localFiltered);
}

function renderRanking(list){
Â  leaderboardEl.innerHTML = '';
Â  if(!list || list.length===0){ leaderboardEl.innerHTML = '<div style="color:var(--muted)">Nenhum score registrado para esta dificuldade.</div>'; return; }
Â  list.slice(0,20).forEach((it, idx)=>{
Â  Â  const row = document.createElement('div'); row.className='leader-row';
Â  Â  row.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div style="font-weight:900;color:var(--accent)">${formatTime(Math.round(it.time))}</div>`;
Â  Â  leaderboardEl.appendChild(row);
Â  });
}


/* ---------- EVENTOS (AJUSTADO) ---------- */
// Handler para a mudanÃ§a de dificuldade
difficultySelect.addEventListener('change', (e) => {
    currentDifficulty = e.target.value;
    localStorage.setItem(STORAGE_DIFF, currentDifficulty);
    computeCardSize(); // Recalcula o tamanho da carta
    createGrid(); // Recria o grid
    loadRanking(); // Recarrega o ranking filtrado pela nova dificuldade
});

startBtn.addEventListener('click', ()=>{ 
    if(started) { // Reinicia o jogo no clique, se jÃ¡ estiver jogando
        createGrid();
    } else {
        createGrid(); 
    }
    computeCardSize(); 
});
resetBtn.addEventListener('click', ()=>{ 
    createGrid(); 
    localStorage.removeItem(STORAGE_RANK); 
    rankNotice.textContent='Ranking local limpo'; 
});
chatSend.addEventListener('click', ()=>{ sendChat(); });
chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
refreshRank.addEventListener('click', ()=>loadRanking());
clearChatBtn.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_CHAT); loadChat(); });

// Conecta os botÃµes de Abas e AutenticaÃ§Ã£o (mantido)
signUpBtn.addEventListener('click', () => handleAuth(true));Â 
signInBtn.addEventListener('click', () => handleAuth(false));
signOutBtn.addEventListener('click', handleSignOut);

tabAppBtn.addEventListener('click', () => showTab('mainApp'));
tabChatBtn.addEventListener('click', () => showTab('chatPanel'));Â 
tabRankBtn.addEventListener('click', () => { 
    showTab('rankPanel'); 
    loadRanking(); // Garante o carregamento do ranking ao abrir a aba
});Â 
tabAuthBtn.addEventListener('click', () => showTab('authPanel'));


/* ---------- INIT (AJUSTADO) ---------- */
function init() {
    // Aplica a dificuldade salva e calcula o tamanho da carta
    difficultySelect.value = currentDifficulty;
    computeCardSize(); 
    createGrid();Â 
    
    // Inicializa o estado de autenticaÃ§Ã£o e carrega nome (assÃ­ncrono)
    supabaseWeb.auth.getSession().then(({ data: { session } }) => updateAuthUI(session?.user));

    // Carrega dados e configura polling
    loadChat();Â 
    loadRanking();
    setInterval(loadChat, POLL_CHAT_MS);
    setInterval(loadRanking, POLL_RANK_MS);

    // Garante que a primeira aba esteja ativa apÃ³s o carregamento completo do DOM
    showTab('mainApp');Â 
}

// Garante que o INIT seja chamado apÃ³s o DOM estar pronto
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
