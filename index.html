<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pixel RPG Memory ‚Äî Multiplayer</title>

<!-- Pixel font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0710; --panel:#0f1020; --accent:#ffcc33; --accent2:#7ce7c7; --muted:#9aa7bf;
    --card-back:#2b2b3a; --card-front:#fefefe;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(circle at 10% 10%, #08121a 0%, transparent 25%),
    linear-gradient(180deg,#081220 0%, #05101a 70%);
    font-family:'Press Start 2P', monospace;color:#e6e6e6;display:flex;align-items:center;justify-content:center;padding:14px;}
  /* Container */
  .wrap{width:100%;max-width:1200px;display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media(max-width:1024px){.wrap{grid-template-columns:1fr;}}

  /* Left panel - game */
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:3px solid rgba(255,255,255,0.03);padding:18px;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.7)}
  .title{color:var(--accent);font-size:14px;margin:0 0 10px 0}
  .subtitle{color:var(--muted);font-size:10px;margin-bottom:12px}

  /* Pixel art board */
  .board-area{display:flex;gap:16px;align-items:flex-start}
  .game-column{flex:1}
  .hud{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .hud .chip{background:#0a0b12;padding:8px;border-radius:6px;border:2px solid rgba(255,255,255,0.02);font-size:11px;color:var(--muted)}

  /* Grid */
  .grid{display:grid;grid-template-columns:repeat(4,92px);gap:10px;justify-content:center;padding:6px;background:linear-gradient(180deg,#061018,#081226);border-radius:8px;border:3px solid rgba(255,255,255,0.02)}
  .card{width:92px;height:92px;perspective:800px;cursor:pointer;filter:drop-shadow(0 4px 6px rgba(0,0,0,0.6))}
  .card-inner{position:relative;width:100%;height:100%;transition:transform .5s;transform-style:preserve-3d;border-radius:6px}
  .card.flipped .card-inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:36px;backface-visibility:hidden}
  .face.front{background:repeating-linear-gradient(135deg,#0b0f1a,#0b0f1a 6px,#0f1422 6px);color:#c8d9ff;transform:rotateY(0deg)}
  .face.back{background:linear-gradient(180deg,#2b1a3a,#1a1230);color:var(--accent2);transform:rotateY(180deg);font-size:28px}

  /* pixel border effect */
  .pixel-frame{box-shadow: inset 0 0 0 3px rgba(0,0,0,0.35), 0 3px 0 rgba(0,0,0,0.6)}
  .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#0b0710;padding:10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:2px dashed rgba(255,255,255,0.04)}

  /* Right panel - chat + leaderboard */
  .side{display:flex;flex-direction:column;gap:12px}
  .box{background:linear-gradient(180deg,#07101a,#06101a);padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.02)}
  .box h3{margin:0 0 8px 0;color:var(--accent);font-size:12px}
  .chat-window{height:360px;overflow:auto;background:linear-gradient(180deg,#071018,#05101a);padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);font-size:12px}
  .chat-row{margin-bottom:8px}
  .chat-name{color:var(--accent2);margin-right:6px}
  .chat-time{color:var(--muted);font-size:10px;margin-left:6px}

  .chat-input{display:flex;gap:6px;margin-top:8px}
  .chat-input input{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:12px}
  .chat-input button{padding:8px 10px;border-radius:6px;border:none;background:var(--accent);font-weight:700;color:#081018;cursor:pointer}

  .leaderboard-list{max-height:240px;overflow:auto}
  .leader-row{display:flex;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));font-size:12px}
  .notice{font-size:11px;color:var(--muted);margin-top:6px}

  /* tiny pixel ornament */
  .pixel-tile{width:10px;height:10px;display:inline-block;background:var(--accent);margin-right:4px;vertical-align:middle}

  footer{margin-top:12px;font-size:11px;color:var(--muted);text-align:center}

/* small */
@media(max-width:1024px){
 .wrap{grid-template-columns:1fr}
 .side{order:2}
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Left: Game -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div>
        <div class="title">PIXEL RPG MEMORY</div>
        <div class="subtitle">Tema: Retro / Pixel ‚Äî Multiplayer (Chat + Ranking)</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--muted)">Conectado a: <span id="apiStatus">API: verificando‚Ä¶</span></div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">Dica: compartilhe o link para subir no ranking</div>
      </div>
    </div>

    <div class="hud">
      <div class="chip">Jogador: <span id="playerNameHUD">Anon</span></div>
      <div class="chip">Tempo: <span id="timeHUD">00:00</span></div>
      <div class="chip">Tentativas: <span id="triesHUD">0</span></div>
      <div class="chip">Melhor local: <span id="bestHUD">--:--</span></div>
    </div>

    <div class="board-area">
      <div class="game-column">
        <div id="grid" class="grid pixel-frame"></div>

        <div class="controls">
          <input id="playerName" placeholder="@seunome" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:11px;width:200px" />
          <select id="skinSelect" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
            <option value="plain">Classic</option>
            <option value="darker">Darker</option>
            <option value="neon">Neon</option>
          </select>
          <button id="startBtn" class="btn">Start</button>
          <button id="resetBtn" class="btn ghost">Reset</button>
        </div>

        <div style="margin-top:10px" class="notice">Ao terminar voc√™ pode enviar seu tempo para o ranking global ‚Äî se a API estiver ativa.</div>
      </div>
    </div>

    <footer>Pixel RPG Memory ‚Äî feito pra Instagram & Vercel</footer>
  </div>

  <!-- Right: Chat + Leaderboard -->
  <div class="side">
    <div class="box">
      <h3>üí¨ Chat Global</h3>
      <div id="chatWindow" class="chat-window"></div>

      <div class="chat-input">
        <input id="chatName" placeholder="Seu nome" />
        <input id="chatMsg" placeholder="Mensagem..." />
        <button id="chatSendBtn">Enviar</button>
      </div>
      <div id="chatNotice" class="notice"></div>
    </div>

    <div class="box">
      <h3>üèÜ Ranking Global</h3>
      <div id="leaderboard" class="leaderboard-list"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="refreshRank" class="btn ghost">Atualizar</button>
        <button id="clearLocal" class="btn ghost">Limpar local</button>
      </div>
      <div id="rankNotice" class="notice"></div>
    </div>
  </div>
</div>

<script>
/*
  Pixel RPG Memory ‚Äî Client (single file)
  - Uses /api/chat and /api/ranking when available.
  - Falls back to localStorage if APIs are not reachable.
  - Chat polling, ranking refresh, graceful messages.
*/

/* ---------- Config ---------- */
const API_CHAT = '/api/chat';
const API_RANKING = '/api/ranking';
const POLL_CHAT_MS = 2000;
const POLL_RANK_MS = 5000;

const EMOJIS = ['üçì','üçç','üçâ','üçá','ü•ù','üçã','ü•≠','üçí'];
const STORAGE_CHAT = 'prm_chat_v1';
const STORAGE_RANK = 'prm_rank_v1';

/* ---------- DOM ---------- */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const playerNameInput = document.getElementById('playerName');
const playerNameHUD = document.getElementById('playerNameHUD');
const timeHUD = document.getElementById('timeHUD');
const triesHUD = document.getElementById('triesHUD');
const bestHUD = document.getElementById('bestHUD');
const apiStatus = document.getElementById('apiStatus');

const chatWindow = document.getElementById('chatWindow');
const chatName = document.getElementById('chatName');
const chatMsg = document.getElementById('chatMsg');
const chatSendBtn = document.getElementById('chatSendBtn');
const chatNotice = document.getElementById('chatNotice');

const leaderboardEl = document.getElementById('leaderboard');
const refreshRank = document.getElementById('refreshRank');
const clearLocal = document.getElementById('clearLocal');
const rankNotice = document.getElementById('rankNotice');

/* ---------- Game State ---------- */
let cards = [];
let first=null, second=null;
let lock=false;
let matches=0;
let attempts=0;
let timer=0, timerId=null;
let started=false;
let bestLocal = localStorage.getItem('prm_best_time') ? parseInt(localStorage.getItem('prm_best_time')) : null;

if(bestLocal) bestHUD.textContent = formatTime(bestLocal);

/* ---------- Helpers ---------- */
function formatTime(s){
  const m = Math.floor(s/60); const sec = s%60;
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

/* ---------- Grid UI ---------- */
function createGrid(){
  grid.innerHTML='';
  const arr = shuffle([...EMOJIS, ...EMOJIS]);
  cards=[];
  arr.forEach((emoji, idx)=>{
    const el = document.createElement('div');
    el.className='card pixel-frame';
    el.dataset.emoji = emoji;
    el.dataset.idx = idx;
    el.innerHTML = `<div class="card-inner"><div class="face front">?</div><div class="face back">${emoji}</div></div>`;
    el.addEventListener('click', onCardClick);
    grid.appendChild(el);
    cards.push(el);
  });
  // reset HUD
  attempts=0; matches=0; triesHUD.textContent = attempts;
  timeHUD.textContent='00:00';
  clearInterval(timerId); timerId=null; timer=0; started=false;
}

/* ---------- Timer ---------- */
function startTimer(){
  if(timerId) return;
  timerId = setInterval(()=>{ timer++; timeHUD.textContent = formatTime(timer); }, 1000);
}
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

/* ---------- Card Logic ---------- */
function onCardClick(e){
  if(lock) return;
  const c = e.currentTarget;
  if(c.classList.contains('flipped')) return;
  if(!started){ started=true; startTimer(); }
  c.classList.add('flipped');
  if(!first) first=c;
  else {
    second=c; lock=true; attempts++; triesHUD.textContent=attempts;
    setTimeout(checkMatch, 550);
  }
}

function checkMatch(){
  if(first.dataset.emoji === second.dataset.emoji){
    matches++;
    first.classList.add('matched'); second.classList.add('matched');
    // small pop
    // reset
    [first,second]=[null,null]; lock=false;
    if(matches === EMOJIS.length){
      stopTimer();
      onWin();
    }
  } else {
    first.classList.remove('flipped'); second.classList.remove('flipped');
    [first,second]=[null,null]; lock=false;
  }
}

/* ---------- Win ---------- */
async function onWin(){
  const name = (playerNameInput.value || 'Anon').slice(0,20);
  playerNameHUD.textContent = name;
  // save locally
  if(bestLocal===null || timer < bestLocal){ bestLocal = timer; localStorage.setItem('prm_best_time', String(bestLocal)); bestHUD.textContent = formatTime(bestLocal); }
  // try to send to server ranking
  const payload = { name, time: timer };
  let sent = false;
  try{
    const res = await fetch(API_RANKING, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok) { sent = true; rankNotice.textContent = 'Tempo enviado ao ranking global!'; }
    else { rankNotice.textContent = 'Ranking offline ‚Äî salvo localmente.'; }
  }catch(e){
    rankNotice.textContent = 'Ranking API indispon√≠vel ‚Äî salvo localmente.';
  }
  if(!sent) {
    // fallback local ranking
    const list = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
    list.push({ name, time: timer, at: Date.now() });
    list.sort((a,b)=>a.time - b.time);
    localStorage.setItem(STORAGE_RANK, JSON.stringify(list.slice(0,50)));
  } else {
    await loadRanking(); // refresh from server
  }
  // show chat invitation
  showModal(`Parab√©ns ${name}!`, `Voc√™ terminou em ${formatTime(timer)}. Compartilhe seu tempo!`);
}

/* ---------- Modal (simple) ---------- */
function showModal(title, msg){
  alert(`${title}\n\n${msg}`);
}

/* ---------- RESET ---------- */
function resetGame(){
  createGrid();
  rankNotice.textContent=''; chatNotice.textContent='';
}

/* ---------- Chat & Ranking API with fallback ---------- */

/* UTIL: safe fetch with timeout */
function fetchTimeout(url, opts={}, timeout=3500){
  return new Promise((resolve, reject)=>{
    const timer = setTimeout(()=>reject(new Error('timeout')), timeout);
    fetch(url, opts).then(r=>{ clearTimeout(timer); resolve(r); }).catch(err=>{ clearTimeout(timer); reject(err); });
  });
}

/* Chat functions */
async function loadChat(){
  // try API
  try{
    const res = await fetchTimeout(API_CHAT, {}, 2500);
    if(res.ok){
      apiStatus.textContent = 'API: OK';
      const data = await res.json();
      renderChat(data);
      return;
    }
  }catch(e){}
  // fallback local
  apiStatus.textContent = 'API: indispon√≠vel (modo local)';
  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
  renderChat(local);
}

function renderChat(list){
  chatWindow.innerHTML = '';
  list.slice(-200).forEach(it=>{
    const div = document.createElement('div'); div.className='chat-row';
    const t = new Date(it.at || Date.now()).toLocaleTimeString();
    div.innerHTML = `<span class="chat-name">${escapeHtml(it.name)}</span>: <span>${escapeHtml(it.msg)}</span> <span class="chat-time">${t}</span>`;
    chatWindow.appendChild(div);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendChat(){
  const name = (chatName.value || playerNameInput.value || 'Anon').slice(0,30);
  const msg = (chatMsg.value || '').trim();
  if(!msg) return;
  const payload = { name, msg };
  try{
    const res = await fetch(API_CHAT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){ chatMsg.value=''; chatNotice.textContent='Mensagem enviada (global)'; return; }
  }catch(e){}
  // fallback local push
  chatNotice.textContent='Chat offline ‚Äî mensagem salva localmente.';
  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
  local.push({ name, msg, at: Date.now() });
  localStorage.setItem(STORAGE_CHAT, JSON.stringify(local.slice(-500)));
  chatMsg.value='';
}

/* Ranking functions */
async function loadRanking(){
  try{
    const res = await fetchTimeout(API_RANKING, {}, 3000);
    if(res.ok){
      const data = await res.json();
      // expected array of {name,time,at}
      apiStatus.textContent = 'API: OK';
      renderRanking(data);
      return;
    }
  }catch(e){}
  // fallback local
  apiStatus.textContent = 'API: indispon√≠vel (modo local)';
  const local = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
  renderRanking(local);
}

function renderRanking(list){
  leaderboardEl.innerHTML = '';
  if(!list || list.length===0){
    leaderboardEl.innerHTML = '<div style="color:var(--muted)">Nenhum score global ainda.</div>';
    return;
  }
  list.slice(0,20).forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='leader-row';
    row.innerHTML = `<div><div style="font-weight:700">${idx+1}. ${escapeHtml(it.name)}</div><div style="font-size:10px;color:var(--muted)">${new Date(it.at || Date.now()).toLocaleString()}</div></div><div style="font-weight:900;color:var(--accent)">${formatTime(Math.round(it.time))}</div>`;
    leaderboardEl.appendChild(row);
  });
}

/* ---------- Utilities ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ---------- Events & Polling ---------- */
startBtn.addEventListener('click', ()=>{ resetGame(); });
resetBtn.addEventListener('click', ()=>{ resetGame(); });

chatSendBtn.addEventListener('click', async ()=>{
  await sendChat(); loadChat();
});
chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') chatSendBtn.click(); });

refreshRank.addEventListener('click', ()=>loadRanking());
clearLocal.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_RANK); renderRanking([]); rankNotice.textContent='Ranking local limpo.'; });

/* Polling */
setInterval(loadChat, POLL_CHAT_MS);
setInterval(loadRanking, POLL_RANK_MS);

/* init */
createGrid();
loadChat();
loadRanking();

/* If user closes/wins, try to send score on unload (best-effort) */
window.addEventListener('beforeunload', async (e)=>{
  // try to send local best if any
  if(bestLocal){
    try{ await fetch(API_RANKING, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: (playerNameInput.value||'Anon'), time: bestLocal }) }); }catch(err){}
  }
});
</script>
</body>
</html>
