<script type="module">
Â  // 1. Importa a biblioteca do Supabase
Â  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

Â  // 2. VariÃ¡veis de conexÃ£o - MANTIDAS COM SEUS VALORES
Â  const SUPABASE_URL = 'https://qkezkaiormdbmknisqdp.supabase.co';Â 
Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXprYWlvcm1kYm1rbmlzcWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjc0NDgsImV4cCI6MjA3ODc0MzQ0OH0.6kDMREZKD6z-ryyxP58ezqINhcZXZaR41cgPsdvRswo';Â 

Â  // 3. Inicializa a conexÃ£o (Web Client)
Â  const supabaseWeb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â Â 
Â  // ----------------------------------------------------
Â  // CONFIGURAÃ‡Ã•ES E VARIÃVEIS
Â  // ----------------------------------------------------
Â Â 
const API_CHAT = '/api/chat';
const API_RANKING = '/api/ranking';
const POLL_CHAT_MS = 2000;
const POLL_RANK_MS = 4000;
const EMOJIS = ['ğŸ“','ğŸ','ğŸ‰','ğŸ‡','ğŸ¥','ğŸ‹','ğŸ¥­','ğŸ’'];
const STORAGE_CHAT = 'prm_chat_v1';
const STORAGE_RANK = 'prm_rank_v1';
const STORAGE_BEST = 'prm_best_v1';

/* ---------- DOM ---------- */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const playerNameInput = document.getElementById('playerName');
const playerHUD = document.getElementById('playerHUD');
const timeHUD = document.getElementById('timeHUD');
const triesHUD = document.getElementById('triesHUD');
const bestHUD = document.getElementById('bestHUD');
const apiStatus = document.getElementById('apiStatus');

const chatWindow = document.getElementById('chatWindow');
const chatName = document.getElementById('chatName');
const chatMsg = document.getElementById('chatMsg');
const chatSend = document.getElementById('chatSend');
const chatNotice = document.getElementById('chatNotice');

const leaderboardEl = document.getElementById('leaderboard');
const refreshRank = document.getElementById('refreshRank');
const clearChatBtn = document.getElementById('clearChat');
const rankNotice = document.getElementById('rankNotice');

// Novos elementos de Auth e Abas
const authStateEl = document.getElementById('authState');
const tabAppBtn = document.getElementById('tabAppBtn');
const tabAuthBtn = document.getElementById('tabAuthBtn');
const mainAppPanel = document.getElementById('mainApp');
const authPanel = document.getElementById('authPanel');
const signUpBtn = document.getElementById('signUpBtn');
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const signOutBtnMobile = document.getElementById('signOutBtnMobile');
const sidePanel = document.getElementById('sidePanel');


/* ---------- STATE ---------- */
let cards = [], first=null, second=null, lock=false, matches=0, attempts=0;
let timer=0, timerId=null, started=false;
let bestLocal = localStorage.getItem(STORAGE_BEST) ? parseInt(localStorage.getItem(STORAGE_BEST)) : null;
if(bestLocal) bestHUD.textContent = formatTime(bestLocal);

/* ---------- RESPONSIVE CARD SIZE ---------- */
function computeCardSize(){
Â  // calculate columns based on viewport width
Â  const containerWidth = Math.min(window.innerWidth - 40, 720); // keep some margin
Â  const cols = window.innerWidth <= 520 ? 3 : 4;
Â  document.documentElement.style.setProperty('--cols', cols);
Â  const gap = 10;
Â  const w = Math.floor((containerWidth - (cols-1)*gap - 16) / cols);
Â  const size = Math.max(56, Math.min(w, 110));
Â  document.documentElement.style.setProperty('--card-size', size + 'px');
}
window.addEventListener('resize', computeCardSize);
computeCardSize();

/* ---------- UTIL ---------- */
function formatTime(s){const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ---------- ABAS ---------- */
function showTab(tabId) {
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');
    document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}Btn`).classList.add('active');
    
    if (tabId === 'mainApp') {
        sidePanel.classList.add('active');
        if (supabaseWeb.auth.getUser() && window.innerWidth <= 980) {
            signOutBtnMobile.style.display = 'block';
        } else {
             signOutBtnMobile.style.display = 'none';
        }
    } else {
        sidePanel.classList.remove('active');
        signOutBtnMobile.style.display = 'none';
    }
}

/* ---------- GRID ---------- */
function createGrid(){
Â  grid.innerHTML='';
Â  const arr = shuffle([...EMOJIS, ...EMOJIS]);
Â  cards = [];
Â  arr.forEach((emoji,idx)=>{
Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'card';
Â  Â  card.dataset.emoji = emoji;
Â  Â  card.innerHTML = `<div class="card-inner"><div class="face front">?</div><div class="face back">${emoji}</div></div>`;
Â  Â  card.addEventListener('click', onCardClick);
Â  Â  grid.appendChild(card);
Â  Â  cards.push(card);
Â  });
Â  resetHUD();
}
function resetHUD(){ attempts=0; matches=0; triesHUD.textContent='0'; stopTimer(); timer=0; timeHUD.textContent='00:00'; started=false; playerHUD.textContent = playerNameInput.value || 'Anon'; }

/* ---------- TIMER ---------- */
function startTimer(){ if(timerId) return; timerId = setInterval(()=>{ timer++; timeHUD.textContent = formatTime(timer); }, 1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

/* ---------- GAME LOGIC ---------- */
function onCardClick(e){
Â  if(lock) return;
Â  const c = e.currentTarget;
Â  if(c.classList.contains('flipped')) return;
Â  if(!started){ started=true; startTimer(); }
Â  c.classList.add('flipped');
Â  if(!first) first=c;
Â  else { second=c; lock=true; attempts++; triesHUD.textContent=attempts; setTimeout(checkMatch, 500); }
}
function checkMatch(){
Â  if(first.dataset.emoji === second.dataset.emoji){
Â  Â  matches++; first.classList.add('matched'); second.classList.add('matched');
Â  Â  [first,second]=[null,null]; lock=false;
Â  Â  if(matches === EMOJIS.length){ stopTimer(); handleWin(); }
Â  } else {
Â  Â  first.classList.remove('flipped'); second.classList.remove('flipped');
Â  Â  [first,second]=[null,null]; lock=false;
Â  }
}

/* ---------- ON WIN: save local + try send to API (Ranking) ---------- */
async function handleWin(){
Â  const name = (playerNameInput.value || 'Anon').slice(0,30);
Â  // save local best
Â  if(!bestLocal || timer < bestLocal){ bestLocal = timer; localStorage.setItem(STORAGE_BEST, String(bestLocal)); bestHUD.textContent = formatTime(bestLocal); }
Â  // attempt to send ranking
Â  const payload = { name, time: timer };
Â  let sent = false;
Â  try{
Â  Â  const res = await fetch(API_RANKING, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
Â  Â  if(res.ok){ sent = true; rankNotice.textContent = 'Tempo enviado ao ranking global!'; }
Â  }catch(e){ rankNotice.textContent = 'Ranking offline â€” salvo localmente'; }
Â  if(!sent){
Â  Â  // fallback local store
Â  Â  const L = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
Â  Â  L.push({ name, time: timer, at: Date.now() });
Â  Â  L.sort((a,b)=>a.time - b.time);
Â  Â  localStorage.setItem(STORAGE_RANK, JSON.stringify(L.slice(0,100)));
Â  } else {
Â  Â  await loadRanking();
Â  }
Â  alert(`ParabÃ©ns ${name}! Tempo: ${formatTime(timer)}.`);
}

/* ---------- AUTENTICAÃ‡ÃƒO (LOGIN/CADASTRO) ---------- */

// FUNÃ‡ÃƒO fetchUserName: Busca e preenche o nome do usuÃ¡rio
async function fetchUserName(userId) {
    // 1. Tenta buscar o nome na tabela 'users'
    const { data, error } = await supabaseWeb
        .from('users')
        .select('name')
        .eq('id', userId)
        .single();
    
    let userName = 'Anon';
    if (error && error.code !== 'PGRST116') { 
        console.error('Erro ao buscar nome do usuÃ¡rio:', error.message);
    }
    
    if (data && data.name) { 
        userName = data.name;
    } 
    
    // 2. Preenche todos os campos relevantes
    playerNameInput.value = userName;
    playerHUD.textContent = userName;
    chatName.value = userName; 
}

// FUNÃ‡ÃƒO updateAuthUI: Atualiza a interface (CORRIGIDO)
function updateAuthUI(user) {
    if (user) {
        authStateEl.innerHTML = `Logado como: ${user.email.split('@')[0]}`;
        signOutBtn.style.display = 'block';
        // Atualiza a visibilidade do botÃ£o mÃ³vel
        signOutBtnMobile.style.display = window.innerWidth <= 980 ? 'block' : 'none';
        signUpBtn.style.display = 'none';
        signInBtn.style.display = 'none';
        
        // Chamada para preencher o nome
        fetchUserName(user.id); 

    } else {
        authStateEl.textContent = 'Status: Desconectado';
        signOutBtn.style.display = 'none';
        signOutBtnMobile.style.display = 'none';
        signUpBtn.style.display = 'inline-block';
        signInBtn.style.display = 'inline-block';
        
        // Limpa e define 'Anon' nos campos quando desconectado
        playerNameInput.value = 'Anon';
        playerHUD.textContent = 'Anon';
        chatName.value = 'Anon';
    }
}

async function handleAuth(isSignUp) {
    const emailEl = document.getElementById('userEmail');
    const passwordEl = document.getElementById('userPassword');
    const playerName = document.getElementById('playerName').value || 'Anon'; 
    
    const email = emailEl.value;
    const password = passwordEl.value;

    if (!email || !password) {
        alert('Por favor, preencha E-mail e Senha.');
        return;
    }

    let authResult;

    if (isSignUp) {
        authResult = await supabaseWeb.auth.signUp({ email, password });
    } else {
        authResult = await supabaseWeb.auth.signInWithPassword({ email, password });
    }

    if (authResult.error) {
        alert(`Erro de autenticaÃ§Ã£o: ${authResult.error.message}`);
        return;
    }
    
    if (authResult.data.user) {
        const userId = authResult.data.user.id;
        const { error: insertError } = await supabaseWeb
            .from('users')
            .upsert([{ id: userId, name: playerName }], { onConflict: 'id' }); 
        
        if (insertError) {
             console.error('Erro ao salvar nome na tabela users:', insertError.message);
        }
    }

    alert(`Sucesso! Verifique seu e-mail para confirmar o cadastro, ou faÃ§a login novamente.`);
    supabaseWeb.auth.getSession().then(({ data: { session } }) => updateAuthUI(session?.user));
    loadChat(); 
    showTab('mainApp'); 
}

async function handleSignOut() {
    const { error } = await supabaseWeb.auth.signOut();
    if (error) {
        alert(`Erro ao sair: ${error.message}`);
        return;
    }
    alert('Desconectado com sucesso!');
    updateAuthUI(null);
    loadChat(); 
}

/* ---------- CHAT (IntegraÃ§Ã£o Supabase) ---------- */
async function loadChat(){
Â  // try API
Â  try{
Â  Â  const res = await fetch(API_CHAT);
Â  Â  if(res.ok){
Â  Â  Â  const data = await res.json();
Â  Â  Â  renderChat(data);
Â  Â  Â  apiStatus.textContent = 'online';
Â  Â  Â  return;
Â  Â  }
Â  }catch(e){}
Â  apiStatus.textContent = 'offline (local)';
Â  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
Â  renderChat(local);
}
function renderChat(list){
Â  chatWindow.innerHTML = '';
Â  list.slice(-200).forEach(it=>{
Â  Â  const row = document.createElement('div'); row.className='chat-row';
Â  Â  const msgText = it.message || it.msg || ''; 
Â  Â  row.innerHTML = `<span class="chat-name">${escapeHtml(it.name)}</span>: ${escapeHtml(msgText)} <span class="chat-time">${new Date(it.at||Date.now()).toLocaleTimeString()}</span>`;
Â  Â  chatWindow.appendChild(row);
Â  });
Â  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// FUNÃ‡ÃƒO sendChat: CORREÃ‡ÃƒO CRÃTICA
async function sendChat() { 
Â  // 1. DEFINE AS VARIÃVEIS (NAME e MSG)
Â  const name = (chatName.value || playerNameInput.value || 'Anon').slice(0, 30);
Â  const msg = (chatMsg.value || '').trim();

Â  if (!msg) return;

Â  // 2. PEGA O ID DO USUÃRIO
Â  // Usamos getSession() para garantir que a sessÃ£o atual (o token) Ã© vÃ¡lida
Â  const { data: { session }, error: sessionError } = await supabaseWeb.auth.getSession();

Â  // CORREÃ‡ÃƒO: Verifica se HÃ SESSÃƒO E se HÃ USUÃRIO. Se nÃ£o tiver, o usuÃ¡rio precisa logar.
Â  if (sessionError || !session || !session.user) {
Â  Â  chatNotice.textContent = 'ERRO: VocÃª deve estar logado para enviar mensagens!';
Â  Â  return;
Â  }
Â  const currentUserId = session.user.id;

Â  // 3. CRIA O PAYLOAD
Â  const payload = { 
Â  Â  name, 
Â  Â  message: msg, 
Â  Â  user_id: currentUserId 
Â  };
Â  
Â  try {
Â  Â  const res = await fetch(API_CHAT, { 
Â  Â  Â  method: 'POST', 
Â  Â  Â  headers: {
            'Content-Type': 'application/json',
            // Adiciona a autorizaÃ§Ã£o JWT para a API verificar se o usuÃ¡rio Ã© vÃ¡lido
            'Authorization': `Bearer ${session.access_token}` 
        }, 
Â  Â  Â  body: JSON.stringify(payload) 
Â  Â  });

Â  Â  if (res.ok) {
Â  Â  Â  chatMsg.value = '';
Â  Â  Â  chatNotice.textContent = 'Mensagem enviada';
Â  Â  Â  loadChat(); 
Â  Â  Â  return; 
Â  Â  }
Â  } catch(e) {
Â  Â  // FALLBACK LOCAL
Â  Â  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
Â  Â  local.push({ name, msg, at: Date.now() });
Â  Â  localStorage.setItem(STORAGE_CHAT, JSON.stringify(local.slice(-500)));
Â  Â  chatMsg.value = '';
Â  Â  chatNotice.textContent = 'Chat offline - mensagem salva localmente';
Â  Â  loadChat();
Â  }
}


/* ---------- RANKING ---------- */
async function loadRanking(){
Â  try{
Â  Â  const res = await fetch(API_RANKING);
Â  Â  if(res.ok){
Â  Â  Â  const data = await res.json();
Â  Â  Â  renderRanking(data);
Â  Â  Â  apiStatus.textContent = 'online';
Â  Â  Â  return;
Â  Â  }
Â  }catch(e){}
Â  apiStatus.textContent = 'offline (local)';
Â  const local = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
Â  renderRanking(local);
}
function renderRanking(list){
Â  leaderboardEl.innerHTML = '';
Â  if(!list || list.length===0){ leaderboardEl.innerHTML = '<div style="color:var(--muted)">Nenhum score registrado.</div>'; return; }
Â  list.slice(0,20).forEach((it, idx)=>{
Â  Â  const row = document.createElement('div'); row.className='leader-row';
Â  Â  row.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div style="font-weight:900;color:var(--accent)">${formatTime(Math.round(it.time))}</div>`;
Â  Â  leaderboardEl.appendChild(row);
Â  });
}


/* ---------- EVENTS ---------- */
startBtn.addEventListener('click', ()=>{ createGrid(); computeCardSize(); });
resetBtn.addEventListener('click', ()=>{ createGrid(); localStorage.removeItem(STORAGE_RANK); rankNotice.textContent='Ranking local limpo'; });
chatSend.addEventListener('click', ()=>{ sendChat(); });
chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
refreshRank.addEventListener('click', ()=>loadRanking());
clearChatBtn.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_CHAT); loadChat(); });

// Conecta os botÃµes de AutenticaÃ§Ã£o e Abas
signUpBtn.addEventListener('click', () => handleAuth(true)); 
signInBtn.addEventListener('click', () => handleAuth(false));
signOutBtn.addEventListener('click', handleSignOut);
signOutBtnMobile.addEventListener('click', handleSignOut);
tabAppBtn.addEventListener('click', () => showTab('mainApp'));
tabAuthBtn.addEventListener('click', () => showTab('authPanel'));


/* ---------- INIT ---------- */
createGrid(); loadChat(); loadRanking();
setInterval(loadChat, POLL_CHAT_MS);
setInterval(loadRanking, POLL_RANK_MS);

// Inicializa a aba principal (CORREÃ‡ÃƒO)
showTab('mainApp'); 

// Inicializa a UI de autenticaÃ§Ã£o
// O getSession() garante que pegamos o usuÃ¡rio logado via localStorage
supabaseWeb.auth.getSession().then(({ data: { session } }) => updateAuthUI(session?.user));

</script>
