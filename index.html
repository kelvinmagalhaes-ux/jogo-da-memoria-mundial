<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pixel RPG Memory ‚Äî Mobile Friendly</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#071017; --panel:#0e1622; --accent:#ffd166; --accent2:#7ce7c7; --muted:#9aa7bf;
  --gap:10px; --cols:4; --card-max:96px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#04101a,#071018);font-family:'Press Start 2P', monospace;color:#eaf2ff;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
.container{max-width:1100px;margin:14px auto;padding:12px;display:grid;grid-template-columns:1fr 340px;gap:16px}
@media(max-width:980px){.container{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.title{color:var(--accent);font-size:12px}
.sub{color:var(--muted);font-size:10px}

/* HUD */
.hud{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.chip{background:#07131a;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-size:11px;color:var(--muted)}

/* Grid responsive: use CSS variable --card-size set by JS */
.grid{display:grid;grid-template-columns:repeat(var(--cols), var(--card-size));gap:var(--gap);justify-content:center;padding:8px;background:linear-gradient(180deg,#04121a,#071426);border-radius:8px}
.card{width:var(--card-size);height:var(--card-size);perspective:700px;border-radius:6px;cursor:pointer;position:relative}
.card-inner{width:100%;height:100%;position:relative;transition:transform .5s;transform-style:preserve-3d;border-radius:6px;box-shadow:0 6px 12px rgba(0,0,0,0.5)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:calc(var(--card-size) * 0.42);backface-visibility:hidden;user-select:none}
.face.front{background:repeating-linear-gradient(45deg,#08131a,#08131a 6px,#0b1a24 6px);color:#bcd7ff}
.face.back{background:linear-gradient(180deg,#2b163a,#151028);color:var(--accent2);transform:rotateY(180deg)}

/* controls (mobile friendly) */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
.input, select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:12px}
.btn{background:var(--accent);color:#071018;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}

.side-column{display:flex;flex-direction:column;gap:12px}
.box{background:linear-gradient(180deg,#061018,#07101a);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-size:12px}
.chat-window{height:300px;overflow:auto;padding:6px;border-radius:6px;background:linear-gradient(180deg,#041016,#051018)}
.chat-row{margin-bottom:8px}
.chat-name{color:var(--accent2);font-weight:700;margin-right:6px}
.chat-time{color:var(--muted);font-size:10px;margin-left:8px}

.leader-row{display:flex;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}

/* small */
.footer{font-size:11px;color:var(--muted);text-align:center;margin-top:8px}
@media (max-width:520px){
  :root{--cols:3}
}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <div class="header">
      <div>
        <div class="title">PIXEL RPG MEMORY</div>
        <div class="sub">Pixel-art moderno ‚Ä¢ Mobile-first</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--muted)">API: <span id="apiStatus">verificando‚Ä¶</span></div>
      </div>
    </div>

    <div class="hud">
      <div class="chip">Jogador: <span id="playerHUD">Anon</span></div>
      <div class="chip">Tempo: <span id="timeHUD">00:00</span></div>
      <div class="chip">Tentativas: <span id="triesHUD">0</span></div>
      <div class="chip">Melhor: <span id="bestHUD">--:--</span></div>
    </div>

    <div id="grid" class="grid"></div>

    <div class="controls">
      <input id="playerName" class="input" placeholder="@seunome" />
      <select id="skinSelect" class="input">
        <option value="plain">Classic</option>
        <option value="darker">Darker</option>
        <option value="neon">Neon</option>
      </select>
      <button id="startBtn" class="btn">Start</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>

    <div class="footer">Toque nas cartas para virar ‚Äî objetivo: terminar no menor tempo</div>
  </div>

  <div class="side-column">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong style="color:var(--accent)">üí¨ Chat Global</strong>
        <button id="clearChat" class="btn ghost" style="padding:6px">Limpar</button>
      </div>
      <div id="chatWindow" class="chat-window"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chatName" class="input" placeholder="Seu nome" />
        <input id="chatMsg" class="input" placeholder="Mensagem..." />
        <button id="chatSend" class="btn">Enviar</button>
      </div>
      <div id="chatNotice" style="margin-top:8px;color:var(--muted);font-size:11px"></div>
    </div>

    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong style="color:var(--accent)">üèÜ Ranking Global</strong>
        <div><button id="refreshRank" class="btn ghost">Atualizar</button></div>
      </div>
      <div id="leaderboard"></div>
      <div id="rankNotice" style="margin-top:8px;color:var(--muted);font-size:11px"></div>
    </div>
  </div>
</div>
<script type="module">
  // 1. Importa a biblioteca do Supabase
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // 2. Vari√°veis de conex√£o - SUBSTITUA ESTES VALORES!
  const SUPABASE_URL = 'https://qkezkaiormdbmknisqdp.supabase.co'; 
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXprYWlvcm1kYm1rbmlzcWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjc0NDgsImV4cCI6MjA3ODc0MzQ0OH0.6kDMREZKD6z-ryyxP58ezqINhcZXZaR41cgPsdvRswo'; 

  // 3. Inicializa a conex√£o (Web Client)
  const supabaseWeb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ----------------------------------------------------
  // O restante do seu c√≥digo JavaScript vem AQUI
  // (incluindo a fun√ß√£o handleWin que corrigimos)
  // ----------------------------------------------------
  
const API_CHAT = '/api/chat';
const API_RANKING = '/api/ranking';
const POLL_CHAT_MS = 2000;
const POLL_RANK_MS = 4000;
const EMOJIS = ['üçì','üçç','üçâ','üçá','ü•ù','üçã','ü•≠','üçí'];
const STORAGE_CHAT = 'prm_chat_v1';
const STORAGE_RANK = 'prm_rank_v1';
const STORAGE_BEST = 'prm_best_v1';

/* ---------- DOM ---------- */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const playerNameInput = document.getElementById('playerName');
const playerHUD = document.getElementById('playerHUD');
const timeHUD = document.getElementById('timeHUD');
const triesHUD = document.getElementById('triesHUD');
const bestHUD = document.getElementById('bestHUD');
const apiStatus = document.getElementById('apiStatus');

const chatWindow = document.getElementById('chatWindow');
const chatName = document.getElementById('chatName');
const chatMsg = document.getElementById('chatMsg');
const chatSend = document.getElementById('chatSend');
const chatNotice = document.getElementById('chatNotice');

const leaderboardEl = document.getElementById('leaderboard');
const refreshRank = document.getElementById('refreshRank');
const clearChatBtn = document.getElementById('clearChat');
const rankNotice = document.getElementById('rankNotice');

/* ---------- STATE ---------- */
let cards = [], first=null, second=null, lock=false, matches=0, attempts=0;
let timer=0, timerId=null, started=false;
let bestLocal = localStorage.getItem(STORAGE_BEST) ? parseInt(localStorage.getItem(STORAGE_BEST)) : null;
if(bestLocal) bestHUD.textContent = formatTime(bestLocal);

/* ---------- RESPONSIVE CARD SIZE ---------- */
function computeCardSize(){
  // calculate columns based on viewport width
  const containerWidth = Math.min(window.innerWidth - 40, 720); // keep some margin
  const cols = window.innerWidth <= 520 ? 3 : 4;
  document.documentElement.style.setProperty('--cols', cols);
  const gap = 10;
  const w = Math.floor((containerWidth - (cols-1)*gap - 16) / cols);
  const size = Math.max(56, Math.min(w, 110));
  document.documentElement.style.setProperty('--card-size', size + 'px');
}
window.addEventListener('resize', computeCardSize);
computeCardSize();

/* ---------- UTIL ---------- */
function formatTime(s){const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

/* ---------- GRID ---------- */
function createGrid(){
  grid.innerHTML='';
  const arr = shuffle([...EMOJIS, ...EMOJIS]);
  cards = [];
  arr.forEach((emoji,idx)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.emoji = emoji;
    card.innerHTML = `<div class="card-inner"><div class="face front">?</div><div class="face back">${emoji}</div></div>`;
    card.addEventListener('click', onCardClick);
    grid.appendChild(card);
    cards.push(card);
  });
  resetHUD();
}
function resetHUD(){ attempts=0; matches=0; triesHUD.textContent='0'; stopTimer(); timer=0; timeHUD.textContent='00:00'; started=false; playerHUD.textContent = playerNameInput.value || 'Anon'; }

/* ---------- TIMER ---------- */
function startTimer(){ if(timerId) return; timerId = setInterval(()=>{ timer++; timeHUD.textContent = formatTime(timer); }, 1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

/* ---------- GAME LOGIC ---------- */
function onCardClick(e){
  if(lock) return;
  const c = e.currentTarget;
  if(c.classList.contains('flipped')) return;
  if(!started){ started=true; startTimer(); }
  c.classList.add('flipped');
  if(!first) first=c;
  else { second=c; lock=true; attempts++; triesHUD.textContent=attempts; setTimeout(checkMatch, 500); }
}
function checkMatch(){
  if(first.dataset.emoji === second.dataset.emoji){
    matches++; first.classList.add('matched'); second.classList.add('matched');
    [first,second]=[null,null]; lock=false;
    if(matches === EMOJIS.length){ stopTimer(); handleWin(); }
  } else {
    first.classList.remove('flipped'); second.classList.remove('flipped');
    [first,second]=[null,null]; lock=false;
  }
}

/* ---------- ON WIN: save local + try send to API ---------- */
async function handleWin(){
  const name = (playerNameInput.value || 'Anon').slice(0,30);
  // save local best
  if(!bestLocal || timer < bestLocal){ bestLocal = timer; localStorage.setItem(STORAGE_BEST, String(bestLocal)); bestHUD.textContent = formatTime(bestLocal); }
  // attempt to send ranking
  const payload = { name, time: timer };
  let sent = false;
  try{
    const res = await fetch(API_RANKING, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){ sent = true; rankNotice.textContent = 'Tempo enviado ao ranking global!'; }
  }catch(e){ rankNotice.textContent = 'Ranking offline ‚Äî salvo localmente'; }
  if(!sent){
    // fallback local store
    const L = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
    L.push({ name, time: timer, at: Date.now() });
    L.sort((a,b)=>a.time - b.time);
    localStorage.setItem(STORAGE_RANK, JSON.stringify(L.slice(0,100)));
  } else {
    await loadRanking();
  }
  alert(`Parab√©ns ${name}! Tempo: ${formatTime(timer)}.`);
}

/* ---------- CHAT ---------- */
async function loadChat(){
  // try API
  try{
    const res = await fetch(API_CHAT);
    if(res.ok){
      const data = await res.json();
      renderChat(data);
      apiStatus.textContent = 'online';
      return;
    }
  }catch(e){}
  apiStatus.textContent = 'offline (local)';
  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
  renderChat(local);
}
function renderChat(list){
  chatWindow.innerHTML = '';
  list.slice(-200).forEach(it=>{
    const row = document.createElement('div'); row.className='chat-row';
    row.innerHTML = `<span class="chat-name">${escapeHtml(it.name)}</span>: ${escapeHtml(it.msg)} <span class="chat-time">${new Date(it.at||Date.now()).toLocaleTimeString()}</span>`;
    chatWindow.appendChild(row);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
async function sendChat(){
  const name = (chatName.value || playerNameInput.value || 'Anon').slice(0,30);
  const msg = (chatMsg.value || '').trim();
  if(!msg) return;
  const payload = { name, msg };
  try{
    const res = await fetch(API_CHAT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){ chatMsg.value=''; chatNotice.textContent='Mensagem enviada'; loadChat(); return; }
  }catch(e){}
  // fallback local
  const local = JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]');
  local.push({ name, msg, at: Date.now() });
  localStorage.setItem(STORAGE_CHAT, JSON.stringify(local.slice(-500)));
  chatMsg.value='';
  chatNotice.textContent='Chat offline ‚Äî mensagem salva localmente';
  loadChat();
}

/* ---------- RANKING ---------- */
async function loadRanking(){
  try{
    const res = await fetch(API_RANKING);
    if(res.ok){
      const data = await res.json();
      renderRanking(data);
      apiStatus.textContent = 'online';
      return;
    }
  }catch(e){}
  apiStatus.textContent = 'offline (local)';
  const local = JSON.parse(localStorage.getItem(STORAGE_RANK) || '[]');
  renderRanking(local);
}
function renderRanking(list){
  leaderboardEl.innerHTML = '';
  if(!list || list.length===0){ leaderboardEl.innerHTML = '<div style="color:var(--muted)">Nenhum score registrado.</div>'; return; }
  list.slice(0,20).forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='leader-row';
    row.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div style="font-weight:900;color:var(--accent)">${formatTime(Math.round(it.time))}</div>`;
    leaderboardEl.appendChild(row);
  });
}

/* ---------- UTIL ---------- */
function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ---------- EVENTS ---------- */
startBtn.addEventListener('click', ()=>{ createGrid(); computeCardSize(); });
resetBtn.addEventListener('click', ()=>{ createGrid(); localStorage.removeItem(STORAGE_RANK); rankNotice.textContent='Ranking local limpo'; });
chatSend.addEventListener('click', ()=>{ sendChat(); });
chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
refreshRank.addEventListener('click', ()=>loadRanking());
clearChatBtn.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_CHAT); loadChat(); });

/* ---------- INIT ---------- */
createGrid(); loadChat(); loadRanking();
setInterval(loadChat, POLL_CHAT_MS);
setInterval(loadRanking, POLL_RANK_MS);
</script>
</body>
</html>

